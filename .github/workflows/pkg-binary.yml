name: Package Binary

on:
  workflow_call:
    inputs:
      arch:
        default: x64
        description: The architecture to build for eg x64 | arm64
        required: true
        type: string
      edge:
        default: false
        description: Whether to build on the edge channel or not
        required: false
        type: boolean
      filename:
        default: lando
        description: The name of the resulting binary
        required: false
        type: string
      os:
        default: linux
        description: The os to build for eg linux | macos | win
        required: true
        type: string
      version:
        default: dev
        description: The version to bump the package.json to
        required: true
        type: string

jobs:
  pkg-binary:
    runs-on: ${{ inputs.arch == 'arm64' && 'macos-14' || 'ubuntu-24.04' }}
    env:
      TERM: xterm
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.5"
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Install plugins
        run: scripts/install-plugins.sh --lando bin/lando --bun ${{ inputs.edge == true && '--edge' || '' }}
      - name: Switch to edge channel
        if: inputs.edge == true
        run: |
          sed -i.bak "s/^channel: stable/channel: edge/" config.yml
          rm -rf config.yml.bak
      - name: Prepare Release
        uses: lando/prepare-release-action@v3
        with:
          version: ${{ inputs.version }}
          sync: false
      - name: Set build target
        id: target
        run: |
          OS=${{ inputs.os }}
          ARCH=${{ inputs.arch }}
          if [ "$OS" = "macos" ]; then OS="darwin"; fi
          if [ "$OS" = "win" ]; then
            echo "target=bun-windows-${ARCH}" >> $GITHUB_OUTPUT
            echo "ext=.exe" >> $GITHUB_OUTPUT
          else
            echo "target=bun-${OS}-${ARCH}" >> $GITHUB_OUTPUT
            echo "ext=" >> $GITHUB_OUTPUT
          fi
      - name: Package into binary
        run: |
          mkdir -p dist
          bun build ./bin/lando --compile --target=${{ steps.target.outputs.target }} --outfile=dist/${{ inputs.filename }}${{ steps.target.outputs.ext }}
      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: packaged-${{ inputs.filename }}-${{ inputs.os }}-${{ inputs.arch }}-${{ github.sha }}
          path: dist/${{ inputs.filename }}${{ steps.target.outputs.ext }}
          if-no-files-found: error
          retention-days: 1
      - name: Ensure version
        if: (inputs.os == 'linux' && runner.os == 'Linux') || (inputs.os == 'macos' && runner.os == 'macOS')
        run: ./dist/${{ inputs.filename }} version --all
      - name: Ensure channel
        if: (inputs.os == 'linux' && runner.os == 'Linux') || (inputs.os == 'macos' && runner.os == 'macOS')
        run: ./dist/${{ inputs.filename }} config --path channel | grep ${{ inputs.edge == true && 'edge' || 'stable' }}
      - name: Ensure plugin install
        if: ((inputs.os == 'linux' && runner.os == 'Linux') || (inputs.os == 'macos' && runner.os == 'macOS'))
        run: |
          ./dist/${{ inputs.filename }} config --path fatcore | grep true
          ./dist/${{ inputs.filename }} config | grep -q "/snapshot/core-next/plugins/wordpress"
